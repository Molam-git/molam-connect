<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molam Secure Card Input</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      padding: 16px;
      background: transparent;
    }

    .field {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #0A84FF;
    }

    input.error {
      border-color: #FF3B30;
    }

    .error-message {
      color: #FF3B30;
      font-size: 12px;
      margin-top: 4px;
    }

    .card-brands {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .card-brand {
      width: 40px;
      height: 24px;
      background: #f5f5f7;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #86868b;
      font-weight: 600;
    }

    .card-brand.active {
      background: #0A84FF;
      color: white;
    }
  </style>
</head>
<body>
  <div class="field">
    <label for="card-number">Card Number</label>
    <input
      type="text"
      id="card-number"
      autocomplete="cc-number"
      placeholder="1234 5678 9012 3456"
      maxlength="19"
      inputmode="numeric"
    >
    <div class="card-brands">
      <div class="card-brand" data-brand="visa">VISA</div>
      <div class="card-brand" data-brand="mastercard">MC</div>
      <div class="card-brand" data-brand="amex">AMEX</div>
    </div>
    <div id="card-number-error" class="error-message"></div>
  </div>

  <div style="display: flex; gap: 12px;">
    <div class="field" style="flex: 1;">
      <label for="exp-month">Expiry Month</label>
      <input
        type="text"
        id="exp-month"
        autocomplete="cc-exp-month"
        placeholder="MM"
        maxlength="2"
        inputmode="numeric"
      >
      <div id="exp-month-error" class="error-message"></div>
    </div>

    <div class="field" style="flex: 1;">
      <label for="exp-year">Expiry Year</label>
      <input
        type="text"
        id="exp-year"
        autocomplete="cc-exp-year"
        placeholder="YYYY"
        maxlength="4"
        inputmode="numeric"
      >
      <div id="exp-year-error" class="error-message"></div>
    </div>

    <div class="field" style="flex: 1;">
      <label for="cvc">CVC</label>
      <input
        type="text"
        id="cvc"
        autocomplete="cc-csc"
        placeholder="123"
        maxlength="4"
        inputmode="numeric"
      >
      <div id="cvc-error" class="error-message"></div>
    </div>
  </div>

  <div class="field">
    <label for="cardholder-name">Cardholder Name</label>
    <input
      type="text"
      id="cardholder-name"
      autocomplete="cc-name"
      placeholder="JOHN DOE"
    >
    <div id="cardholder-name-error" class="error-message"></div>
  </div>

  <script>
    // Luhn algorithm for card validation
    function validateLuhn(cardNumber) {
      const digits = cardNumber.replace(/\D/g, '');
      let sum = 0;
      let isEven = false;

      for (let i = digits.length - 1; i >= 0; i--) {
        let digit = parseInt(digits[i], 10);

        if (isEven) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }

        sum += digit;
        isEven = !isEven;
      }

      return sum % 10 === 0;
    }

    // Detect card brand
    function detectCardBrand(cardNumber) {
      const digits = cardNumber.replace(/\D/g, '');
      const firstDigit = digits[0];
      const firstTwo = digits.substring(0, 2);
      const firstFour = digits.substring(0, 4);

      if (firstDigit === '4') return 'visa';
      if (['51', '52', '53', '54', '55'].includes(firstTwo)) return 'mastercard';
      if (['34', '37'].includes(firstTwo)) return 'amex';

      return null;
    }

    // Format card number with spaces
    function formatCardNumber(value) {
      const digits = value.replace(/\D/g, '');
      const matches = digits.match(/.{1,4}/g);
      return matches ? matches.join(' ') : digits;
    }

    // DOM elements
    const cardNumberInput = document.getElementById('card-number');
    const expMonthInput = document.getElementById('exp-month');
    const expYearInput = document.getElementById('exp-year');
    const cvcInput = document.getElementById('cvc');
    const cardholderNameInput = document.getElementById('cardholder-name');

    const cardNumberError = document.getElementById('card-number-error');
    const expMonthError = document.getElementById('exp-month-error');
    const expYearError = document.getElementById('exp-year-error');
    const cvcError = document.getElementById('cvc-error');
    const cardholderNameError = document.getElementById('cardholder-name-error');

    // Card number formatting
    cardNumberInput.addEventListener('input', (e) => {
      const formatted = formatCardNumber(e.target.value);
      e.target.value = formatted;

      // Detect and highlight brand
      const brand = detectCardBrand(formatted);
      document.querySelectorAll('.card-brand').forEach(el => {
        el.classList.toggle('active', el.dataset.brand === brand);
      });

      // Clear error
      cardNumberError.textContent = '';
      cardNumberInput.classList.remove('error');

      // Notify parent of changes
      notifyParent('change', { field: 'cardNumber', valid: false });
    });

    // Expiry month validation
    expMonthInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value;

      if (value.length === 2) {
        const month = parseInt(value, 10);
        if (month < 1 || month > 12) {
          expMonthError.textContent = 'Invalid month';
          expMonthInput.classList.add('error');
        } else {
          expMonthError.textContent = '';
          expMonthInput.classList.remove('error');
          expYearInput.focus();
        }
      }

      notifyParent('change', { field: 'expMonth', valid: false });
    });

    // Expiry year validation
    expYearInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value;

      if (value.length === 4) {
        const year = parseInt(value, 10);
        const currentYear = new Date().getFullYear();
        if (year < currentYear || year > currentYear + 20) {
          expYearError.textContent = 'Invalid year';
          expYearInput.classList.add('error');
        } else {
          expYearError.textContent = '';
          expYearInput.classList.remove('error');
          cvcInput.focus();
        }
      }

      notifyParent('change', { field: 'expYear', valid: false });
    });

    // CVC validation
    cvcInput.addEventListener('input', (e) => {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value = value;

      if (value.length >= 3) {
        cvcError.textContent = '';
        cvcInput.classList.remove('error');
        if (value.length === 3) {
          cardholderNameInput.focus();
        }
      }

      notifyParent('change', { field: 'cvc', valid: false });
    });

    // Listen for tokenization request from parent
    window.addEventListener('message', async (event) => {
      // Validate origin (TODO: check against allowed merchant origins)
      // if (event.origin !== 'https://merchant.com') return;

      if (event.data.type === 'TOKENIZE_CARD') {
        const cardData = validateAndCollectCardData();

        if (cardData.errors.length > 0) {
          notifyParent('tokenization_error', { errors: cardData.errors });
          return;
        }

        try {
          // Call tokenization service
          const response = await fetch('/api/v1/tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pan: cardData.pan,
              exp_month: cardData.exp_month,
              exp_year: cardData.exp_year,
              cvc: cardData.cvc,
              name: cardData.name,
              billing_country: event.data.billing_country || 'SN',
              usage: event.data.usage || 'single',
              merchant_id: event.data.merchant_id
            })
          });

          const result = await response.json();

          if (response.ok) {
            notifyParent('tokenization_success', result);
          } else {
            notifyParent('tokenization_error', { error: result.error });
          }
        } catch (error) {
          notifyParent('tokenization_error', { error: error.message });
        }
      }
    });

    // Validate and collect card data
    function validateAndCollectCardData() {
      const errors = [];
      const pan = cardNumberInput.value.replace(/\s/g, '');
      const exp_month = parseInt(expMonthInput.value, 10);
      const exp_year = parseInt(expYearInput.value, 10);
      const cvc = cvcInput.value;
      const name = cardholderNameInput.value.trim().toUpperCase();

      // Validate card number
      if (!pan || pan.length < 13 || pan.length > 19) {
        errors.push({ field: 'card_number', message: 'Invalid card number length' });
        cardNumberInput.classList.add('error');
      } else if (!validateLuhn(pan)) {
        errors.push({ field: 'card_number', message: 'Invalid card number' });
        cardNumberInput.classList.add('error');
      }

      // Validate expiry
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      if (!exp_month || exp_month < 1 || exp_month > 12) {
        errors.push({ field: 'exp_month', message: 'Invalid month' });
        expMonthInput.classList.add('error');
      }

      if (!exp_year || exp_year < currentYear || exp_year > currentYear + 20) {
        errors.push({ field: 'exp_year', message: 'Invalid year' });
        expYearInput.classList.add('error');
      }

      if (exp_year === currentYear && exp_month < currentMonth) {
        errors.push({ field: 'expiry', message: 'Card expired' });
        expMonthInput.classList.add('error');
        expYearInput.classList.add('error');
      }

      // Validate CVC
      if (!cvc || cvc.length < 3 || cvc.length > 4) {
        errors.push({ field: 'cvc', message: 'Invalid CVC' });
        cvcInput.classList.add('error');
      }

      // Validate name
      if (!name || name.length < 2) {
        errors.push({ field: 'name', message: 'Invalid cardholder name' });
        cardholderNameInput.classList.add('error');
      }

      return {
        pan,
        exp_month,
        exp_year,
        cvc,
        name,
        errors
      };
    }

    // Notify parent window via postMessage
    function notifyParent(type, data) {
      window.parent.postMessage({
        type: `MOLAM_HOSTED_${type.toUpperCase()}`,
        data
      }, '*'); // TODO: Restrict to merchant origin
    }

    // Notify parent that iframe is ready
    window.addEventListener('load', () => {
      notifyParent('ready', { iframe: 'hosted_card' });
    });
  </script>
</body>
</html>
