# ============================================================================
# Brique 121 — Bank Connectors Environment Configuration
# ============================================================================

# ─────────────────────────────────────────────────────────────────────────────
# Database Configuration
# ─────────────────────────────────────────────────────────────────────────────
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/molam_connect
DB_POOL_MIN=2
DB_POOL_MAX=20
DB_IDLE_TIMEOUT_MS=10000
DB_CONNECTION_TIMEOUT_MS=5000

# ─────────────────────────────────────────────────────────────────────────────
# HashiCorp Vault Configuration
# ─────────────────────────────────────────────────────────────────────────────
VAULT_ADDR=http://localhost:8200
VAULT_TOKEN=root
# OR use AppRole authentication (production)
# VAULT_ROLE_ID=your-role-id
# VAULT_SECRET_ID=your-secret-id
VAULT_NAMESPACE=molam-dev
VAULT_MOUNT_PATH=secret

# ─────────────────────────────────────────────────────────────────────────────
# HSM Configuration
# ─────────────────────────────────────────────────────────────────────────────
HSM_TYPE=mock
# Options: mock, softhsm, aws_cloudhsm, thales, utimaco
HSM_KEY_ID=default-signing-key
# For AWS CloudHSM
# HSM_ENDPOINT=https://cloudhsm.us-east-1.amazonaws.com
# HSM_PARTITION=prod-partition
# HSM_USERNAME=crypto-user
# HSM_PASSWORD=<from-vault>

# ─────────────────────────────────────────────────────────────────────────────
# Circuit Breaker & Retry Configuration
# ─────────────────────────────────────────────────────────────────────────────
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2
CIRCUIT_BREAKER_TIMEOUT_MS=60000
CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS=3

RETRY_MAX_ATTEMPTS=3
RETRY_INITIAL_DELAY_MS=1000
RETRY_MAX_DELAY_MS=30000
RETRY_BACKOFF_MULTIPLIER=2
RETRY_JITTER=true

# ─────────────────────────────────────────────────────────────────────────────
# Connector Timeouts
# ─────────────────────────────────────────────────────────────────────────────
CONNECTOR_DEFAULT_TIMEOUT_MS=15000
CONNECTOR_HEALTH_CHECK_TIMEOUT_MS=5000
CONNECTOR_STATEMENT_UPLOAD_TIMEOUT_MS=30000

# ─────────────────────────────────────────────────────────────────────────────
# REST Connector Configuration (Sandbox)
# ─────────────────────────────────────────────────────────────────────────────
REST_SANDBOX_ENDPOINT=https://sandbox-api.example.com/v1
REST_SANDBOX_API_KEY=vault:bank/sandbox/api_key
REST_SANDBOX_HMAC_KEY=vault:bank/sandbox/hmac
REST_SANDBOX_TIMEOUT_MS=15000

# ─────────────────────────────────────────────────────────────────────────────
# MT940/SFTP Connector Configuration
# ─────────────────────────────────────────────────────────────────────────────
SFTP_HOST=sftp.bank.example.com
SFTP_PORT=22
SFTP_USERNAME=molam_user
SFTP_PASSWORD=vault:bank/sftp/password
# OR use private key
# SFTP_PRIVATE_KEY=vault:bank/sftp/private_key
SFTP_REMOTE_PATH=/statements/inbound
SFTP_ARCHIVE_PATH=/statements/archive
SFTP_POLL_INTERVAL_MS=300000

# ─────────────────────────────────────────────────────────────────────────────
# ISO20022 Connector Configuration
# ─────────────────────────────────────────────────────────────────────────────
ISO20022_ENDPOINT=https://iso20022.bank.example.com/api
ISO20022_DEBTOR_IBAN=SN08SN0100152000048500019761
ISO20022_DEBTOR_NAME=Molam Financial Technology
ISO20022_DEBTOR_BIC=MOLAMSNDA
ISO20022_MESSAGE_ID_PREFIX=MOLAM
ISO20022_HSM_SIGN=true
ISO20022_SIGNING_KEY_ID=prod-signing-key-2024

# ─────────────────────────────────────────────────────────────────────────────
# mTLS Configuration
# ─────────────────────────────────────────────────────────────────────────────
MTLS_CERT_PATH=vault:bank/prod/mtls/cert
MTLS_KEY_PATH=vault:bank/prod/mtls/key
MTLS_CA_PATH=vault:bank/prod/mtls/ca
MTLS_VERIFY_PEER=true

# ─────────────────────────────────────────────────────────────────────────────
# Observability
# ─────────────────────────────────────────────────────────────────────────────
LOG_LEVEL=info
# Options: trace, debug, info, warn, error, fatal
ENABLE_STRUCTURED_LOGGING=true
ENABLE_PROMETHEUS_METRICS=true
PROMETHEUS_PORT=9090

# OpenTelemetry (optional)
OTEL_ENABLED=false
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
OTEL_SERVICE_NAME=bank-connector-worker

# ─────────────────────────────────────────────────────────────────────────────
# Worker Configuration
# ─────────────────────────────────────────────────────────────────────────────
WORKER_CONCURRENCY=5
WORKER_POLL_INTERVAL_MS=5000
WORKER_BATCH_SIZE=20
WORKER_ENABLE_DLQ=true
WORKER_MAX_RETRIES=5

# ─────────────────────────────────────────────────────────────────────────────
# Statement Processing
# ─────────────────────────────────────────────────────────────────────────────
STATEMENT_S3_BUCKET=molam-bank-statements
STATEMENT_S3_REGION=us-east-1
STATEMENT_RETENTION_DAYS=2555
# 7 years for regulatory compliance
STATEMENT_AUTO_RECONCILE=true

# ─────────────────────────────────────────────────────────────────────────────
# Security & Compliance
# ─────────────────────────────────────────────────────────────────────────────
ENABLE_AUDIT_LOGGING=true
ENCRYPT_LOGS=true
LOG_ENCRYPTION_KEY=vault:security/log-encryption-key
PCI_COMPLIANCE_MODE=true
MASK_SENSITIVE_DATA=true

# ─────────────────────────────────────────────────────────────────────────────
# Rate Limiting
# ─────────────────────────────────────────────────────────────────────────────
RATE_LIMIT_REQUESTS_PER_MINUTE=100
RATE_LIMIT_BURST=20
RATE_LIMIT_REDIS_URL=redis://localhost:6379/1

# ─────────────────────────────────────────────────────────────────────────────
# Development & Testing
# ─────────────────────────────────────────────────────────────────────────────
NODE_ENV=development
# Options: development, staging, production
ENABLE_DEBUG_MODE=false
MOCK_BANK_RESPONSES=false
DRY_RUN_MODE=false
# If true, don't actually send payments

# ─────────────────────────────────────────────────────────────────────────────
# Alerting
# ─────────────────────────────────────────────────────────────────────────────
ALERT_ON_CIRCUIT_BREAKER_OPEN=true
ALERT_ON_HIGH_FAILURE_RATE=true
ALERT_FAILURE_RATE_THRESHOLD=0.1
# Alert if >10% failures
ALERT_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
PAGERDUTY_API_KEY=vault:ops/pagerduty/api_key

# ─────────────────────────────────────────────────────────────────────────────
# Regional Settings
# ─────────────────────────────────────────────────────────────────────────────
DEFAULT_TIMEZONE=Africa/Dakar
DEFAULT_CURRENCY=XOF
SUPPORTED_CURRENCIES=XOF,EUR,USD,GBP

# ─────────────────────────────────────────────────────────────────────────────
# Advanced Features
# ─────────────────────────────────────────────────────────────────────────────
ENABLE_AUTO_RETRY=true
ENABLE_CIRCUIT_BREAKER=true
ENABLE_IDEMPOTENCY_CHECK=true
ENABLE_WEBHOOK_NOTIFICATIONS=true
WEBHOOK_RETRY_ATTEMPTS=3

# ─────────────────────────────────────────────────────────────────────────────
# Performance Tuning
# ─────────────────────────────────────────────────────────────────────────────
HTTP_KEEP_ALIVE=true
HTTP_KEEP_ALIVE_TIMEOUT_MS=60000
HTTP_MAX_SOCKETS=100
HTTP_MAX_FREE_SOCKETS=10

# ─────────────────────────────────────────────────────────────────────────────
# End of Configuration
# ─────────────────────────────────────────────────────────────────────────────
