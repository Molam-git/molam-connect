name: Brique 118 - Playground E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'brique-117/**'
      - 'brique-118/**'
      - '.github/workflows/playground-e2e.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'brique-117/**'
      - 'brique-118/**'
  workflow_dispatch:

jobs:
  # Job 1: Unit Tests (Jest)
  unit-tests:
    name: Unit Tests - Mock Sandbox
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'brique-118/mock-sandbox/package-lock.json'

      - name: Install dependencies
        working-directory: brique-118/mock-sandbox
        run: npm ci

      - name: Run Jest tests
        working-directory: brique-118/tests/jest
        run: |
          npm install
          npm test -- --coverage --ci

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./brique-118/tests/jest/coverage/lcov.info
          flags: unit-tests
          name: mock-sandbox-coverage

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jest-test-results
          path: brique-118/tests/jest/coverage

  # Job 2: Database Setup & Migration
  database-setup:
    name: Database Migration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass123
          POSTGRES_DB: molam_connect_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run migrations
        env:
          PGPASSWORD: testpass123
        run: |
          for migration in brique-117/migrations/*.sql; do
            echo "Running migration: $migration"
            psql -h localhost -U postgres -d molam_connect_test -f "$migration"
          done

      - name: Seed test database
        env:
          DB_HOST: localhost
          DB_USER: postgres
          DB_NAME: molam_connect_test
          PGPASSWORD: testpass123
        run: |
          chmod +x brique-118/test-scripts/seed_test_db.sh
          ./brique-118/test-scripts/seed_test_db.sh

      - name: Verify database state
        env:
          PGPASSWORD: testpass123
        run: |
          psql -h localhost -U postgres -d molam_connect_test -c "SELECT COUNT(*) FROM playground_sessions;"
          psql -h localhost -U postgres -d molam_connect_test -c "SELECT COUNT(*) FROM playground_snippets;"

  # Job 3: E2E Tests (Cypress)
  e2e-tests:
    name: E2E Tests - Cypress
    runs-on: ubuntu-latest
    needs: [unit-tests]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass123
          POSTGRES_DB: molam_connect_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies - Mock Sandbox
        working-directory: brique-118/mock-sandbox
        run: npm ci

      - name: Install dependencies - Playground
        working-directory: brique-117/playground
        run: npm ci

      - name: Run database migrations
        env:
          PGPASSWORD: testpass123
        run: |
          for migration in brique-117/migrations/*.sql; do
            psql -h localhost -U postgres -d molam_connect_test -f "$migration"
          done

      - name: Seed test database
        env:
          DB_HOST: localhost
          DB_USER: postgres
          DB_NAME: molam_connect_test
          PGPASSWORD: testpass123
        run: |
          chmod +x brique-118/test-scripts/seed_test_db.sh
          ./brique-118/test-scripts/seed_test_db.sh

      - name: Start Mock Sandbox
        working-directory: brique-118/mock-sandbox
        run: |
          npm start &
          npx wait-on http://localhost:4001/healthz --timeout 30000

      - name: Start Playground Backend
        working-directory: brique-117/playground
        env:
          DATABASE_URL: postgresql://postgres:testpass123@localhost:5432/molam_connect_test
          MOCK_SANDBOX_URL: http://localhost:4001
          PORT: 8082
        run: |
          npm start &
          npx wait-on http://localhost:8082/health --timeout 30000

      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: brique-118
          browser: chrome
          config-file: cypress.json
          spec: tests/cypress/integration/**/*.spec.js
        env:
          CYPRESS_BASE_URL: http://localhost:8082

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: brique-118/cypress/screenshots

      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: brique-118/cypress/videos

      - name: Cleanup test database
        if: always()
        env:
          DB_HOST: localhost
          DB_USER: postgres
          DB_NAME: molam_connect_test
          PGPASSWORD: testpass123
        run: |
          chmod +x brique-118/test-scripts/cleanup_test_db.sh
          ./brique-118/test-scripts/cleanup_test_db.sh

  # Job 4: Docker Compose Tests
  docker-tests:
    name: Docker Compose E2E
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and run tests with Docker Compose
        working-directory: brique-118/docker
        run: |
          docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from cypress

      - name: Upload Docker test logs
        if: always()
        run: |
          docker-compose -f brique-118/docker/docker-compose.test.yml logs > docker-logs.txt

      - name: Archive Docker logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-logs
          path: docker-logs.txt

      - name: Cleanup Docker containers
        if: always()
        working-directory: brique-118/docker
        run: docker-compose -f docker-compose.test.yml down -v

  # Job 5: Report Test Results
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, database-setup, e2e-tests, docker-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate test summary
        run: |
          echo "# Brique 118 - Playground E2E Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit Tests: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Database Setup: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… E2E Tests: Completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker Tests: Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Brique 118 tests passed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
